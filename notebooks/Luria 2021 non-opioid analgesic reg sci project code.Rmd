---
title: "Non-opioid analgesics reg sci project_scratch"
author: "Cat Luria"
date: "3/29/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(ggplot2)
library(stringr)
library(forcats)
library(dplyr)
library(survival)
library(ggfortify)
library(tidyverse)


```

### Defining a cohort

```{r echo=FALSE, message=FALSE}

#drugs with WHO ATC N02, dowloaded from Adis Insights on 2021-03-29 (all indications)
drugs_ATC_NO2_expanded <- read.delim("../data/drugs.txt", stringsAsFactors=FALSE)
drugs_ATC_NO2_expanded_dt <- data.table(drugs_ATC_NO2_expanded)

```


```{r echo=FALSE, message=FALSE}

## add column Highest.Development.Phase.Simpler which only states what phase drug is in regardless of status and column Highest.Development.Phase.Activity that states whether development is active or inactive. "discontinued", "suspended", "no development reported", "withdrawl" all categorized as inactive.

atc_n02_phases <- drugs_ATC_NO2_expanded_dt[, Highest.Development.Phase.Simple := Highest.Development.Phase]
atc_n02_phases$Highest.Development.Phase.Activity <- "Active"


##remove rows with non-useful highest development phase
atc_n02_phases <- atc_n02_phases[ ! Highest.Development.Phase.Simple %like% "Unknown"]
atc_n02_phases <- atc_n02_phases[ ! Highest.Development.Phase.Simple %like% "\\(Clinical\\)"]
atc_n02_phases <- atc_n02_phases[ ! Highest.Development.Phase.Simple %like% "0"]
atc_n02_phases <- atc_n02_phases[ Highest.Development.Phase.Simple != "Discontinued"]
atc_n02_phases <- atc_n02_phases[ Highest.Development.Phase.Simple != "No development reported"]
################################


##Categorize all statuses "No development reported", "Suspended", "Discontinued", "Withdrawal" as "Inactive" 
atc_n02_phases$Highest.Development.Phase.Activity[atc_n02_phases$Highest.Development.Phase %like% "No development reported" ] <- "Inactive"
atc_n02_phases$Highest.Development.Phase.Activity[atc_n02_phases$Highest.Development.Phase %like% "Discontinued" ] <- "Inactive"
atc_n02_phases$Highest.Development.Phase.Activity[atc_n02_phases$Highest.Development.Phase %like% "Suspended" ] <- "Inactive"
atc_n02_phases$Highest.Development.Phase.Activity[atc_n02_phases$Highest.Development.Phase %like% "Withdrawal" ] <- "Inactive"
################################


## Change all statuses to simplest version: Research, Preclinical Phases I-III, Preregistration, Registered, and Marketed
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(Research\\)" ] <- "Research"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(Preclinical\\)" ] <- "Preclinical"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(I\\)" ] <- "Phase I"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "Phase I/II" ] <- "Phase I"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(I/II\\)" ] <- "Phase I"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "Phase II/III" ] <- "Phase II"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(II\\)" ] <- "Phase II"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(II/III\\)" ] <- "Phase II"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(III\\)" ] <- "Phase III"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(Registered\\)" ] <- "Registered"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "\\(Preregistration\\)" ] <- "Preregistration"
atc_n02_phases$Highest.Development.Phase.Simple[atc_n02_phases$Highest.Development.Phase.Simple %like% "Withdrawal" ] <- "Marketed"
################################


##stacked histogram showing frequency of development levels coded by activity/inactivity
# p <- ggplot(atc_n02_phases, aes(x=Highest.Development.Phase.Simple, fill=Highest.Development.Phase.Activity)) + geom_histogram(stat="count") + coord_flip() +  scale_x_discrete(limits = c("Marketed", "Registered", "Preregistration", "Phase III", "Phase II", "Phase I", "Preclinical", "Research"))           
# 
# show(p)




```


```{r echo=FALSE, message=FALSE}


## add new column Highest.Development.Phase.Survival and convert phase from Highest.Development.Phase.Simple into a numeric score in order to generate "survival curve"

atc_n02_phases <- atc_n02_phases[, Highest.Development.Phase.Survival := Highest.Development.Phase.Simple]
atc_n02_phases <- atc_n02_phases[, Highest.Development.Phase.Status := Highest.Development.Phase.Activity]


atc_n02_phases$Highest.Development.Phase.Survival[atc_n02_phases$Highest.Development.Phase.Survival == "Research"] <- 0
atc_n02_phases$Highest.Development.Phase.Survival[atc_n02_phases$Highest.Development.Phase.Survival == "Preclinical"] <- 1
atc_n02_phases$Highest.Development.Phase.Survival[atc_n02_phases$Highest.Development.Phase.Survival == "Phase I"] <- 2
atc_n02_phases$Highest.Development.Phase.Survival[atc_n02_phases$Highest.Development.Phase.Survival == "Phase II"] <- 3
atc_n02_phases$Highest.Development.Phase.Survival[atc_n02_phases$Highest.Development.Phase.Survival == "Phase III"] <- 4
atc_n02_phases$Highest.Development.Phase.Survival[atc_n02_phases$Highest.Development.Phase.Survival == "Preregistration"] <- 5
atc_n02_phases$Highest.Development.Phase.Survival[atc_n02_phases$Highest.Development.Phase.Survival == "Registered"] <- 6
atc_n02_phases$Highest.Development.Phase.Survival[atc_n02_phases$Highest.Development.Phase.Survival == "Marketed"] <- 7
 


atc_n02_phases$Highest.Development.Phase.Status[atc_n02_phases$Highest.Development.Phase.Activity == "Active"] <- 1
atc_n02_phases$Highest.Development.Phase.Status[atc_n02_phases$Highest.Development.Phase.Activity == "Inactive"] <- 0     



```



```{r echo=FALSE, message=FALSE}

#atc_n02_phases <- atc_n02_phases[,atc_n02_phases$ATC]

N02A_cols <- colnames(atc_n02_phases %>% select(contains("N02A")))
N02B_cols <- colnames(atc_n02_phases %>% select(contains("N02B")))

##goal: for atc_no2_phases[row, ] in any column listed in N02A_cols, if 1+ columns has a "1", then atc_n02_phases$ATC[A=N02A,]


atc_n02_phases$ATC <- "other"

atc_n02_phases$ATC[rowSums(data.frame(atc_n02_phases)[,N02A_cols]) > 0 &
                     rowSums(data.frame(atc_n02_phases)[,N02B_cols]) == 0] <- "N02A"

atc_n02_phases$ATC[rowSums(data.frame(atc_n02_phases)[,N02B_cols]) > 0 &
                     rowSums(data.frame(atc_n02_phases)[,N02A_cols]) == 0] <- "N02B"

atc_n02_phases2 <- atc_n02_phases[atc_n02_phases$ATC!="other",]


#n02B <- atc_n02_phases %>% filter_at(vars(contains('N02B')), any_vars(. == 1))
#n02A <- atc_n02_phases %>% filter_at(vars(contains('N02A')), any_vars(. == 1))


atc_n02_phases2$Highest.Development.Phase.Survival <- as.numeric(atc_n02_phases2$Highest.Development.Phase.Survival)

atc_n02_phases2$Highest.Development.Phase.Status <- as.numeric(atc_n02_phases2$Highest.Development.Phase.Status)


atc_n02_phases_plot <- 
  atc_n02_phases2 %>%
  group_by(ATC, Highest.Development.Phase.Status, Highest.Development.Phase.Survival) %>%
  summarise(
    n = n(),
  )

p <- atc_n02_phases2 %>%
  group_by(ATC, Highest.Development.Phase.Status) %>%
  summarise(
    n = n(),
  )

```


All drugs in WHO ATC class N02 were downloaded from Adis Insight database on March 29, 2021. Of these, 329 were opioids (N02A) and 427 were non-opioids (N02B). Drugs classified as both N02A and N02B were excluded, leaving a total cohort of 756 drugs. Drugs with latest phase of development indicating suspension, discontinuation, no development reported for several years or market withdrawl were categorized here as "inactive". Similar proportions--approximately one third--of both N02A and N02B drugs were "active". 


```{r echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.cap="Distribution of opioid (N02A) and non-opioid (N02B) analgesics in active development and inactive (e.g. 'suspended', 'discontinued', 'no development reported', or 'withdrawn') among phases of development."}

phases <- c(
  "0" = "Research",
  "1" = "Preclin",
  "2" = "Phase I",
  "3" = "Phase II",
  "4" = "Phase III",
  "5" = "Prereg",
  "6" = "Registered",
  "7" = "Marketed"
)



classes <- c("Non-opioid", "Opioid")

ggplot(atc_n02_phases_plot, 
       aes(fill=as.factor(Highest.Development.Phase.Status), x=ATC, y=n)) + 
    geom_bar(position="stack", stat="identity") +
  scale_x_discrete(labels = classes) + 
 scale_fill_discrete(labels=c("inactive", "active"), name="Status") +
  labs(x="Drug class") +
  facet_grid(Highest.Development.Phase.Survival~., labeller=labeller(Highest.Development.Phase.Survival=phases)) +
  coord_flip() +
  theme(legend.position="bottom", legend.direction = "horizontal", strip.text.y = element_text(angle=0))

```

```{r echo=FALSE, fig.cap="Survival curve showing at which stage of development opioid (N02A) and non-opioid (N02B) analgesics shift from active development to inactive (e.g. 'suspended', 'discontinued', 'no development reported', or 'withdrawn'), only drugs significantly updated in the last decade."}


fit <- survfit(Surv(atc_n02_phases3$Highest.Development.Phase.Survival, atc_n02_phases3$Highest.Development.Phase.Status)~ATC, data = atc_n02_phases3)
autoplot(fit)

```

```{r echo=FALSE}

#remove drugs that have not been significantly updated in the last 10 years

atc_n02_phases2$Last.Significant.Update.Date.Date <- as.Date(atc_n02_phases2$Last.Significant.Update.Date, "%d/%m/%Y")
atc_n02_phases3 <- atc_n02_phases2[atc_n02_phases2$Last.Significant.Update.Date.Date>="2011-05-01",]

atc_n02_phases3 %>%
  group_by(ATC) %>%
  summarise(
    n = n(),
  )

```

```{r echo=FALSE}

#generate list of drugs that are Phase 1 or later to use in searching ct.gov

atc_n02_phases_export <- atc_n02_phases3[atc_n02_phases3$Highest.Development.Phase.Survival>=2,] 
drug_list <- atc_n02_phases_export$Drug.Name
write.csv(rbind(drug_list), file="data/drug_list_20210503.csv", row.names=FALSE)

```


```{r echo=FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.cap="Distribution of opioid (N02A) and non-opioid (N02B) analgesics in active development and inactive (e.g. 'suspended', 'discontinued', 'no development reported', or 'withdrawn') among phases of development. Drugs with no significant updates within last ten years are not shown."}

phases <- c(
  "0" = "Research",
  "1" = "Preclin",
  "2" = "Phase I",
  "3" = "Phase II",
  "4" = "Phase III",
  "5" = "Prereg",
  "6" = "Registered",
  "7" = "Marketed"
)

atc_n02_phases_plot <- 
  atc_n02_phases_3 %>%
  group_by(ATC, Highest.Development.Phase.Status, Highest.Development.Phase.Survival) %>%
  summarise(
    n = n(),
  )


classes <- c("Non-opioid", "Opioid")

ggplot(atc_n02_phases_plot, 
       aes(fill=as.factor(Highest.Development.Phase.Status), x=ATC, y=n)) + 
    geom_bar(position="stack", stat="identity") +
  scale_x_discrete(labels = classes) + 
 scale_fill_discrete(labels=c("inactive", "active"), name="Status") +
  labs(x="Drug class") +
  facet_grid(Highest.Development.Phase.Survival~., labeller=labeller(Highest.Development.Phase.Survival=phases)) +
  coord_flip() +
  theme(legend.position="bottom", legend.direction = "horizontal", strip.text.y = element_text(angle=0))

```

```{r echo=FALSE, fig.cap="Survival curve showing at which stage of development opioid (N02A) and non-opioid (N02B) analgesics shift from active development to inactive (e.g. 'suspended', 'discontinued', 'no development reported', or 'withdrawn'), only drugs significantly updated in the last decade."}


fit <- survfit(Surv(atc_n02_phases3$Highest.Development.Phase.Survival, atc_n02_phases3$Highest.Development.Phase.Status)~ATC, data = atc_n02_phases3)
autoplot(fit)

```

